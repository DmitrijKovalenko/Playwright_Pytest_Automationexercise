name: Deploy Allure Report

on:
  workflow_run:
    workflows: ["CI Tests"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and Merge Allure results
        run: |
          mkdir -p allure-results
          artifacts_url=$(jq --raw-output '.workflow_run.artifacts_url' "${GITHUB_EVENT_PATH}")
          
          curl -sS "${artifacts_url}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            | jq --raw-output '.artifacts[] | select(.name | startswith("allure-results-")) | .archive_download_url' \
            | while read -r url; do
              curl -sL -o "artifact.zip" "${url}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}"
              unzip -o artifact.zip -d allure-results
              rm artifact.zip
            done

      - name: Generate Allure HTML report
        uses: simple-elf/allure-report-action@v1.9
        with:
          allure_results: allure-results
          
      - name: Setup Pages
        uses: actions/configure-pages@v5 
        
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3 
        with:
          path: 'allure-report'
          
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4